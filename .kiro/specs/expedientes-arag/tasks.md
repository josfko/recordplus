# Implementation Plan: Expedientes ARAG

## Overview

Implementation of the ARAG insurance case automation module including PDF document generation (minutas and suplidos), digital signatures, automated email sending, and mileage expense tracking. The implementation builds on the existing core case management system.

## Tasks

- [x] 1. Set up dependencies and database migration
  - [x] 1.1 Install required npm packages (pdfkit, pdf-lib, nodemailer)
    - Add pdfkit, pdf-lib, nodemailer to package.json
    - Run npm install
    - _Requirements: 11.1, 12.1_
  - [x] 1.2 Create database migration for SMTP configuration
    - Create migrations/002_smtp_configuration.sql
    - Add configuration keys: documents_path, certificate_path, certificate_password, smtp_host, smtp_port, smtp_secure, smtp_user, smtp_password, smtp_from
    - Run migration
    - _Requirements: 12.1_
  - [x] 1.3 Create documents directory structure
    - Create data/documents directory
    - Create data/certificates directory
    - _Requirements: 2.5_

- [x] 2. Implement PDF Generator Service
  - [x] 2.1 Create PDFGeneratorService class
    - Create src/server/services/pdfGeneratorService.js
    - Implement generateMinuta method with PDFKit
    - Include law firm header, case details, fee breakdown
    - Format currency in Spanish locale (€, comma decimal)
    - Format dates in DD/MM/YYYY
    - Generate A4 format PDFs
    - _Requirements: 2.1, 2.2, 11.1, 11.3, 11.4, 11.5, 11.6_
  - [x] 2.2 Implement generateSuplido method
    - Add suplido PDF generation to PDFGeneratorService
    - Include case details, district, mileage amount
    - Use same formatting standards as minuta
    - _Requirements: 7.1, 11.2_
  - [x] 2.3 Write property tests for PDF generation
    - **Property 22: PDF Format Compliance**
    - Test A4 format, Spanish currency/date formatting
    - **Validates: Requirements 11.4, 11.5, 11.6**

- [x] 3. Implement Digital Signature Service
  - [x] 3.1 Create SignatureService class
    - Create src/server/services/signatureService.js
    - Implement signPDF method using pdf-lib
    - Add visual signature indicator to PDF
    - Save signed PDF with \_signed suffix
    - _Requirements: 3.1, 3.2_
  - [x] 3.2 Implement certificate verification
    - Add verifyCertificate method
    - Check certificate file exists and is readable
    - _Requirements: 3.4_
  - [x] 3.3 Write property tests for signature service
    - **Property 7: Digital Signature Application**
    - Test signed file exists, differs from original
    - **Validates: Requirements 3.1, 3.2, 3.3**

- [x] 4. Implement Email Service
  - [x] 4.1 Create EmailService class
    - Create src/server/services/emailService.js
    - Implement initialize method with nodemailer transporter
    - Support TLS/SSL configuration
    - _Requirements: 12.1, 12.2_
  - [x] 4.2 Implement sendEmail method
    - Send email with PDF attachment
    - Use configured from address
    - _Requirements: 4.1, 4.6_
  - [x] 4.3 Implement testConnection method
    - Verify SMTP connection
    - Return success/failure status
    - _Requirements: 12.4_
  - [x] 4.4 Write property tests for email service
    - **Property 8: Email Subject Format**
    - Test subject matches "{aragReference} - MINUTA" format
    - **Validates: Requirements 4.3**

- [x] 5. Implement Document and Email History Services
  - [x] 5.1 Create DocumentHistoryService class
    - Create src/server/services/documentHistoryService.js
    - Implement create, getById, getByCaseId methods
    - Implement updateSigned method
    - _Requirements: 2.6, 10.2_
  - [x] 5.2 Create EmailHistoryService class
    - Create src/server/services/emailHistoryService.js
    - Implement create, getById, getByCaseId methods
    - Support SENT and ERROR status
    - _Requirements: 4.4, 4.5, 10.3_
  - [x] 5.3 Write property tests for history services
    - **Property 6: Document History Recording**
    - **Property 9: Email History Recording**
    - **Property 21: History Ordering**
    - Test records created with correct fields, ordered by date DESC
    - **Validates: Requirements 2.6, 4.4, 10.5**

- [x] 6. Checkpoint - Ensure all service tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [x] 7. Implement Minuta Workflow Service
  - [x] 7.1 Create MinutaWorkflowService class
    - Create src/server/services/minutaWorkflowService.js
    - Orchestrate: generate PDF → sign → record document → send email → record email
    - Track step progress and status
    - _Requirements: 5.1_
  - [x] 7.2 Implement error handling and recovery
    - Stop workflow on step failure
    - Record partial progress
    - Record ERROR status in email_history if email fails
    - _Requirements: 5.4, 4.5_
  - [x] 7.3 Write property tests for workflow
    - **Property 10: Workflow Step Ordering**
    - Test steps execute in order, failure stops subsequent steps
    - **Validates: Requirements 5.1**

- [x] 8. Implement API Routes
  - [x] 8.1 Create ARAG routes file
    - Create src/server/routes/arag.js
    - Set up Express router
    - _Requirements: All_
  - [x] 8.2 Implement POST /api/cases/:id/minuta endpoint
    - Validate case is ARAG type
    - Validate case is not archived
    - Execute minuta workflow
    - Return workflow result
    - _Requirements: 2.1, 5.1_
  - [x] 8.3 Implement POST /api/cases/:id/suplido endpoint
    - Validate case is ARAG type
    - Validate case is in JUDICIAL state
    - Validate distrito is in allowed list
    - Generate and sign suplido PDF
    - Record in document_history
    - _Requirements: 7.1, 7.2, 6.6_
  - [x] 8.4 Implement GET /api/documents/:id/download endpoint
    - Retrieve document from document_history
    - Send file for download
    - _Requirements: 10.4_
  - [x] 8.5 Implement GET /api/cases/:id/history endpoint
    - Return documents and emails for case
    - Order by date descending
    - _Requirements: 10.1, 10.5_
  - [x] 8.6 Implement POST /api/email/test endpoint
    - Test SMTP configuration
    - Return success/failure
    - _Requirements: 12.4_
  - [x] 8.7 Register routes in main server
    - Import aragRouter in src/server/index.js
    - Mount at /api/cases for case-specific routes
    - Mount at /api/documents for document routes
    - Mount at /api/email for email routes
    - _Requirements: All_

- [x] 9. Implement validation functions
  - [x] 9.1 Add ARAG reference validation
    - Extend src/server/services/referenceGenerator.js if needed
    - Validate DJ00 + 6 digits format
    - _Requirements: 1.1, 1.5_
  - [x] 9.2 Add partido judicial validation
    - Create validation function for allowed districts
    - Torrox, Vélez-Málaga, Torremolinos, Fuengirola, Marbella, Estepona, Antequera
    - _Requirements: 7.2_
  - [x] 9.3 Add mileage rate validation
    - Validate positive numbers only
    - _Requirements: 8.3_
  - [x] 9.4 Write property tests for validations
    - **Property 1: ARAG Reference Format Validation**
    - **Property 14: Partido Judicial Validation**
    - **Property 17: Mileage Rate Validation**
    - **Validates: Requirements 1.1, 1.5, 7.2, 8.3**

- [x] 10. Checkpoint - Ensure all backend tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [x] 11. Implement amount calculation functions
  - [x] 11.1 Create minuta amount calculator
    - Calculate base fee, VAT amount, total
    - Use configuration values
    - _Requirements: 2.3, 2.4_
  - [x] 11.2 Create mileage amount lookup
    - Get rate from configuration by district key
    - _Requirements: 7.3, 8.5_
  - [x] 11.3 Write property tests for calculations
    - **Property 5: Minuta Amount Calculation**
    - **Property 15: Mileage Amount Calculation**
    - Test total = base + (base × rate / 100)
    - **Validates: Requirements 2.3, 7.3**

- [x] 12. Update API client
  - [x] 12.1 Add minuta generation method to api.js
    - POST /api/cases/:id/minuta
    - _Requirements: 5.1_
  - [x] 12.2 Add suplido generation method to api.js
    - POST /api/cases/:id/suplido with district parameter
    - _Requirements: 7.1_
  - [x] 12.3 Add document download method to api.js
    - GET /api/documents/:id/download
    - _Requirements: 10.4_
  - [x] 12.4 Add case history method to api.js
    - GET /api/cases/:id/history
    - _Requirements: 10.1_
  - [x] 12.5 Add email test method to api.js
    - POST /api/email/test
    - _Requirements: 12.4_

- [x] 13. Update FacturacionArag frontend component
  - [x] 13.1 Implement minuta generation button handler
    - Call api.generateMinuta(caseId)
    - Show progress during workflow steps
    - Display success/error notification
    - _Requirements: 5.1, 5.2, 5.3_
  - [x] 13.2 Implement suplido generation
    - Get selected district from dropdown
    - Call api.generateSuplido(caseId, district)
    - Display result
    - _Requirements: 7.1, 7.7_
  - [x] 13.3 Implement real-time amount display
    - Update suplido amount when district changes
    - Fetch rate from configuration
    - _Requirements: 8.4_
  - [x] 13.4 Implement document history timeline
    - Fetch history from api.getCaseHistory(caseId)
    - Render documents and emails in timeline
    - Add download links for documents
    - Show status indicators (sent/error)
    - _Requirements: 10.1, 10.2, 10.3, 10.4, 10.6_

- [x] 14. Update Configuration component
  - [x] 14.1 Add SMTP configuration fields
    - Host, port, secure, user, password, from
    - Save to configuration table
    - _Requirements: 12.1_
  - [x] 14.2 Add test email button
    - Call api.testEmail()
    - Display connection result
    - _Requirements: 12.4_
  - [x] 14.3 Add certificate path configuration
    - Input for certificate file path
    - Input for certificate password
    - _Requirements: 3.4_

- [x] 15. Add facturacion-specific CSS styles
  - [x] 15.1 Create facturacion.css
    - Create src/client/css/facturacion.css
    - Style workflow progress indicators
    - Style timeline with document/email events
    - Style success/error status badges
    - Use pure vanilla CSS (no Tailwind)
    - _Requirements: 10.6, 6.7_
  - [x] 15.2 Import styles in main.css
    - Add import for facturacion.css
    - _Requirements: All_

- [x] 16. Checkpoint - Ensure frontend works end-to-end
  - Ensure all tests pass, ask the user if questions arise.

- [x] 17. Implement state transition restrictions
  - [x] 17.1 Add archived case document restriction
    - Prevent minuta/suplido generation for archived cases
    - Return appropriate error message
    - _Requirements: 9.3_
  - [x] 17.2 Add suplido judicial state restriction
    - Prevent suplido generation for non-judicial cases
    - Return appropriate error message
    - _Requirements: 6.6_
  - [x] 17.3 Write property tests for restrictions
    - **Property 13: Suplido State Restriction**
    - **Property 19: Archived Case Document Restriction**
    - **Validates: Requirements 6.6, 9.3**

- [x] 18. Implement history preservation
  - [x] 18.1 Verify history preserved on archive
    - Ensure document_history and email_history remain after case archive
    - No cascade delete on archive
    - _Requirements: 9.4_
  - [x] 18.2 Write property test for history preservation
    - **Property 20: History Preservation on Archive**
    - **Validates: Requirements 9.4**

- [x] 19. Final integration testing
  - [x] 19.1 Write integration test for complete minuta workflow
    - Create ARAG case → Generate minuta → Verify document and email history
    - _Requirements: 5.1_
  - [x] 19.2 Write integration test for suplido workflow
    - Create ARAG case → Transition to judicial → Generate suplido
    - _Requirements: 7.1, 6.2_
  - [x] 19.3 Write integration test for archive restrictions
    - Create case → Archive → Verify document generation blocked
    - _Requirements: 9.3_

- [x] 20. Final checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

## Notes

- All tasks are required for comprehensive implementation
- Each task references specific requirements for traceability
- Checkpoints ensure incremental validation
- Property tests validate universal correctness properties
- Unit tests validate specific examples and edge cases
- The implementation uses existing database schema (cases, document_history, email_history, configuration tables)
- PDF generation uses PDFKit (lightweight, no external dependencies)
- Digital signatures use pdf-lib for PDF manipulation
- Email sending uses Nodemailer with SMTP transport
